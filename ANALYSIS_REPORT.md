# 在宅勤務申請システム要件分析レポート

## 1. はじめに

本レポートは、提供された「システム要求仕様書」および「テストデータ」に基づき、既存の在宅勤務申請システムを分析し、要求仕様を満たすために必要な機能追加・修正点を洗い出した結果をまとめたものです。この分析は、後続の開発タスクの計画と実装の基礎となることを目的とします。

## 2. 機能要件の分析

要求仕様書に記載された各機能要件と、既存システムの現状を比較分析しました。

| No. | 機能要件 | 実装状況 | 備考・開発方針 |
| :-- | :--- | :--- | :--- |
| 3-(1),(2) | 権限管理（申請者、承認者、管理者） | **実装済み** | `Role`モデル（申請者、承認者、管理者）と`manager`による階層構造で基本的な権限管理は実現済み。 |
| 3-ア | 所属毎の承認者 | **実装済み** | `User`モデルの`manager`関連で実現。 |
| 3-イ | 勤続年数に応じた申請回数制限 | **未実装** | `users.hired_date`を基に勤続年数を計算し、週の申請回数を制限するロジックの新規開発が必要。 |
| 3-ウ,ク,オ,カ,コ | 特認承認の各種ルール | **部分的実装** | `is_special`フラグと理由は存在するが、申請期限（前営業日まで）、時間外・深夜早朝利用、天候による日数超過許可などの詳細な制御ロジックの追加開発が必要。 |
| 3-エ | 8時間超勤務の申請 | **実装済み** | `is_overtime`フラグ、理由、終了時刻のカラムで実現済み。 |
| 3-キ | 部分在宅勤務のカウント方法 | **未実装** | `work_option`（半休）を0.5回としてカウントし、週の申請回数上限に合算するロジックの新規開発が必要。 |
| 3-サ | 育児・介護による申請上限 | **未実装** | ユーザーが対象者かを示すフラグを`User`モデルに追加し、月10回までとする特別な上限ロジックの新規開発が必要。 |
| 3-(4) | 利用状況の可視化（ダッシュボード） | **実装済み** | フロントエンドに`dashboard`ページが存在し、基本的な統計情報を表示するコンポーネントが実装済み。 |
| 3-(5) | CSV出力機能 | **実装済み** | 管理者向けにCSVエクスポート用のエンドポイントが存在する。要件に合わせた出力項目の調整は必要になる可能性あり。 |
| 3-(6) | Outlook連携 | **部分的実装** | Microsoft Graph APIとの認証連携の基盤は存在する。予定表への実際の書き込み処理などの追加開発が必要。 |
| 3-(7),ケ | 路線情報の自動取得と自動承認 | **未実装** | 外部交通情報APIとの連携、運行状況の監視、申請の自動作成・承認といった大規模な新規開発が必要。 |

### 複雑なルールに関する実装方針

- **申請回数制限（勤続年数、部分在宅、育児・介護）:**
  - `Application`モデルのバリデーションで、ユーザーの勤続年数や育児・介護フラグに応じて、週次・月次の申請回数をチェックするロジックを実装します。半休申請は0.5回としてカウントします。

- **特認承認の条件:**
  - 申請日時と日本の祝日を考慮した営業日計算を行い、当日以降の申請は自動で特認扱いとします。
  - 申請された勤務時間帯をチェックし、深夜・早朝（5時以前、22時以降、5時～7時）の場合は特認扱いとします。

- **路線情報の自動承認:**
  - 外部の交通情報APIと連携するサービスを新規に構築します。
  - 定期実行ジョブ（Sidekiq等）でユーザー登録路線の運行状況を監視し、計画運休や運転見合わせを検知した場合、対象ユーザーの申請を自動で特認承認済みの状態で作成します。

## 3. データモデルの分析

提供された社員情報（テストデータ）を管理するため、既存のデータモデル（`User`モデルおよび関連モデル）の拡張が必要です。

### 3.1. `users`テーブルへのカラム追加

| カラム名 | データ型 | 理由 |
| :--- | :--- | :--- |
| `group_id` | `bigint` (FK) | 社員が所属するグループを管理するため。`groups`テーブルと関連付けます。 |
| `position` | `string` | 社員の役職（例: チーフ、グループリーダー）を管理するため。 |
| `is_caregiver` | `boolean` | 介護対象の家族を持つ社員を識別し、申請上限ルールを適用するため。 |
| `has_child_under_elementary` | `boolean` | 小学校1年生までの子を持つ社員を識別し、申請上限ルールを適用するため。 |

### 3.2. 新規テーブルの追加

- **`groups`テーブル:**
  - `id`, `name`, `department_id` (FK) といったカラムを持ち、部署（`departments`）との親子関係を表現します。これにより、テストデータにあるような「部-グループ」の階層構造を管理可能にします。

## 4. 非機能要件と制約条件の考慮

- **パフォーマンス（利用者1000人）:**
  - 現行のRails+MySQL構成で対応可能ですが、利用状況集計などの重い処理については、適切なインデックス設計やバックグラウンド処理化を検討する必要があります。

- **シングルサインオン（SSO）:**
  - `devise_saml_authenticatable`等のgemを追加導入し、既存の認証基盤と連携させることで実現可能です。連携先のIDプロバイダに応じた設定が必要です。

- **サービスイン時期（2026年3月）:**
  - 約4ヶ月という開発期間は、要求される機能追加の規模に対して**非常にタイト**です。特に「路線情報の自動取得・承認」や「SSO連携」は工数が大きくなることが予想されます。
  - **提案:** MVP（Minimum Viable Product）を定義し、優先度の高い機能からリリースする段階的な開発計画を立てることを強く推奨します。例えば、路線情報連携はフェーズ2の機能とすることが考えられます。

- **人事異動対応:**
  - 既存の`user_info_changes`テーブルによる事前申請の仕組みは、今回のデータモデル拡張（グループ、役職の追加）に合わせて改修が必要です。具体的には、`user_info_changes`テーブルに`new_group_id`, `new_position`カラムを追加し、変更処理を対応させます。

## 5. まとめと次のステップ

本分析により、要求仕様を満たすための具体的な開発・修正項目が明確になりました。データモデルの拡張、複雑な業務ロジックの実装、外部サービス連携など、多岐にわたる作業が必要です。

次のステップとして、この分析レポートを基に開発チームとステークホルダーでレビューを行い、機能の優先度付けと詳細な開発計画・スケジュールの策定に進むことを推奨します。